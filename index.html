<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur CSV La Poste</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px auto;
            max-width: 600px;
            line-height: 1.6;
        }
        .container {
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Générateur CSV compatible La Poste</h1>
        <textarea id="addressInput" placeholder="Collez ici l'adresse à convertir"></textarea>
        <button onclick="generateCSV()">Générer le fichier CSV</button>
    </div>

    <script>
        function parseAddress(text) {
            const lines = text.trim().split(/\n/).map(line => line.trim());
            let data = {
                societe: '',
                identite: '',
                civilite: '',
                nom: '',
                prenom: '',
                voie: '',
                codePostal: '',
                ville: '',
                pays: 'France',
                lieuditBP: '',
                infoComplementaire: ''
            };

            if (lines.length === 0) {
                alert("Veuillez entrer une adresse.");
                return null;
            }

            // Identifier si c'est un particulier ou une société
            const firstLine = lines[0];
            if (/monsieur|madame|mme|mr|m\./i.test(firstLine)) {
                // Particulier
                data.civilite = /madame|mme/i.test(firstLine) ? "madame" : "monsieur";
                const nameParts = firstLine.replace(/(monsieur|madame|mme|mr|m\.)/i, "").trim().split(" ");
                data.nom = nameParts.pop().toUpperCase();
                data.prenom = nameParts.join(" ");
            } else {
                // Société
                data.societe = firstLine;
                data.identite = lines[1] || '';
            }

            // Traiter le reste des lignes pour extraire l'adresse
            lines.forEach(line => {
                if (/^\d{5}/.test(line)) {
                    const [codePostal, ...villeParts] = line.split(" ");
                    data.codePostal = codePostal;
                    data.ville = villeParts.join(" ");
                } else if (/^\d+\s/.test(line)) {
                    data.voie = line;
                }
            });

            return data;
        }

        function generateCSV() {
            const input = document.getElementById("addressInput").value;
            const addressData = parseAddress(input);
            if (!addressData) return;

            // Construire le CSV
            const header = "Nom de la société;Identité du destinataire et/ou service;Civilité (autorisée: monsieur ou madame);Nom;Prénom;N° et libellé de voie;Code postal;Ville;Pays;Lieu-dit/BP;Information complémentaire";
            const dataLine = `${addressData.societe};${addressData.identite};${addressData.civilite};${addressData.nom};${addressData.prenom};${addressData.voie};${addressData.codePostal};${addressData.ville};${addressData.pays};${addressData.lieuditBP};${addressData.infoComplementaire}`;
            const csvContent = `${header}\n${dataLine}`;

            // Télécharger le fichier
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "adresses_laposte.csv");
            link.style.display = "none";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
