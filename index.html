<script>
    function parseAddress(text) {
        const lines = text.trim().split(/[\n,]+/).map(line => line.trim()).filter(line => line);
        let data = {
            societe: '',
            identite: '',
            civilite: '',
            nom: '',
            prenom: '',
            voie: '',
            codePostal: '',
            ville: '',
            pays: 'France',
            lieuditBP: '',
            infoComplementaire: ''
        };

        // Vérifier si l'adresse est pour un particulier ou professionnel
        const isPro = !lines[0].toLowerCase().match(/monsieur|madame|mme|mr|m\./);
        if (isPro) {
            // Adresse professionnelle
            data.societe = lines[0];
            data.identite = lines[1] || '';
            for (let i = 2; i < lines.length; i++) {
                const line = lines[i];
                if (/^\d{5}/.test(line)) {
                    const [codePostal, ...villeParts] = line.split(' ');
                    data.codePostal = codePostal;
                    data.ville = villeParts.join(' ');
                } else if (/^\d+/.test(line)) {
                    data.voie = line;
                }
            }
        } else {
            // Adresse particulière
            const firstLine = lines[0];
            if (/madame|mme/i.test(firstLine)) {
                data.civilite = 'madame';
            } else {
                data.civilite = 'monsieur';
            }
            const nameParts = firstLine.replace(/monsieur|madame|mme|mr|m\./i, '').trim().split(' ');
            data.nom = nameParts.pop().toUpperCase();
            data.prenom = nameParts.join(' ');
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (/^\d{5}/.test(line)) {
                    const [codePostal, ...villeParts] = line.split(' ');
                    data.codePostal = codePostal;
                    data.ville = villeParts.join(' ');
                } else if (/^\d+/.test(line)) {
                    data.voie = line;
                }
            }
        }
        return data;
    }

    function generateCSV() {
        const input = document.getElementById('addressInput').value;
        if (!input.trim()) {
            alert('Veuillez entrer une adresse');
            return;
        }

        const addressData = parseAddress(input);

        // Ligne d'en-tête
        const header = 'Nom de la société;Identité du destinataire et/ou service;Civilité (autorisée: monsieur ou madame);Nom;Prénom;N° et libellé de voie;Code postal;Ville;Pays;Lieu-dit/BP;Information complémentaire';

        // Ligne de données
        const dataLine = `${addressData.societe};${addressData.identite};${addressData.civilite};${addressData.nom};${addressData.prenom};${addressData.voie};${addressData.codePostal};${addressData.ville};${addressData.pays};${addressData.lieuditBP};${addressData.infoComplementaire}`;

        // Combiner en contenu CSV
        const csvContent = `${header}\n${dataLine}`;

        // Création du fichier CSV
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', 'adresse_laposte.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
